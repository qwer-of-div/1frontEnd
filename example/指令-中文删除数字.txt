/*
  é™åˆ¶è¾“å…¥æ¡†åªèƒ½è¾“å…¥æ•°å­—ã€å­—æ¯ã€ä¸­æ–‡ç­‰è§„åˆ™

  ä½¿ç”¨æŒ‡ä»¤ï¼šv-input

  ä¿®é¥°ç¬¦å‚æ•°è¯´æ˜ï¼š
    v-input.num åªèƒ½è¾“å…¥æ•°å­—ï¼Œé»˜è®¤ä¸ä¼ ä¿®é¥°ç¬¦ï¼Œä¼šè‡ªåŠ¨é™åˆ¶åªèƒ½è¾“å…¥æ•°å­—
    v-input.intp åªèƒ½è¾“å…¥æ­£æ•´æ•°
    v-input.num_alp åªèƒ½è¾“å…¥æ•°å­—å’Œå­—æ¯
    v-input.num_alp_blank åªèƒ½è¾“å…¥æ•°å­—ã€å­—æ¯ã€ç©ºæ ¼
    v-input.num_alp_sym åªèƒ½è¾“å…¥æ•°å­—å’Œå­—æ¯ã€è‹±æ–‡ç¬¦å·ã€ç©ºæ ¼
    v-input.float åªèƒ½è¾“å…¥æ•°å­—å’Œå°æ•°ç‚¹  v-input.float="2" è¡¨ç¤ºå°æ•°ä½æ•°ä¸º2ï¼Œé»˜è®¤å°æ•°ä½æ•°ä¸º2ï¼Œv-input.float="2"å¯ä»¥ç®€å†™ä¸ºv-input.float
    v-input.no_emoji ä¸èƒ½è¾“å…¥è¡¨æƒ…ç¬¦å·

*/
// åªèƒ½è¾“å…¥æ•°å­—
function num(el) {
  el.value = el.value.replace(/\D+/g, '')
}

// åªèƒ½è¾“å…¥æ­£æ•´æ•°
function intp(el) {
  const value = el.value.replace(/\D+/g, '') // å»æ‰éæ•°å­—å­—ç¬¦
  el.value = /^[1-9][0-9]*$/.test(value) ? value : value.replace(/^0+/, '') // ç¡®ä¿ä¸ºæ­£æ•´æ•°ï¼Œå»æ‰å‰å¯¼é›¶
}

// åªèƒ½è¾“å…¥æ•°å­—å’Œå­—æ¯
function num_alp(el) {
  el.value = el.value.replace(/[^A-Za-z0-9]/g, '')
}

// åªèƒ½è¾“å…¥æ•°å­—ã€å­—æ¯ã€ç©ºæ ¼
function num_alp_blank(el) {
  const regex = /[^a-zA-Z0-9 ]/g
  el.value = el.value.replace(regex, '')
}

// åªèƒ½è¾“å…¥æ•°å­—ã€å­—æ¯ã€è‹±æ–‡ç¬¦å·ã€ç©ºæ ¼
function num_alp_sym(el) {
  const regex = /[^a-zA-Z0-9`~!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/? ]/g
  el.value = el.value.replace(regex, '')
}

// åªèƒ½è¾“å…¥æ•°å­—å’Œå°æ•°ç‚¹ï¼Œnè¡¨ç¤ºå°æ•°ä½æ•°
function float(el, n) {
  let value = el.value
  value = value.replace(/[^\d.]/g, '') // èƒ½æ•°å­—å’Œå°æ•°ç‚¹
  value = value.replace(/^\./g, '') // å»æ‰å¼€å¤´çš„ç‚¹
  value = value.replace('.', '$#$').replace(/\./g, '').replace('$#$', '.') // å¤„ç†å¤šä¸ªç‚¹çš„æƒ…å†µ
  if (n && Number(n) > 0) {
    const d = new Array(Number(n)).fill('\\d').join('') // æ„å»ºæ­£åˆ™è¡¨è¾¾å¼
    const reg = new RegExp(`^(\\-)*(\\d+)\\.(${d}).*$`, 'ig')
    value = value.replace(reg, '$1$2.$3') // é™åˆ¶å°æ•°ä½æ•°
  }
  // if (value && !value.includes('.')) {
  //   value = Number(value).toString() // å»æ‰å¼€å¤´å¤šä¸ª0
  // }
  el.value = value
}

// é™åˆ¶è¡¨æƒ…ï¼šğŸ˜€ğŸ˜‚â¤ï¸ğŸŒŸğŸ‰ğŸŒğŸ¶â˜º
function no_emoji(el) {
  const regex =
    /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E6}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{263A}]+/gu
  el.value = el.value.replace(regex, '')
}

// è¿™é‡Œæ‰©å±•é™åˆ¶çš„ç±»å‹
const map = { num, intp, num_alp, num_alp_blank, num_alp_sym, float, no_emoji }

export default {
  bind(el, binding, vnode) {
    el = el.querySelector('.el-input__inner') || el.querySelector('.el-textarea__inner') || el
    let lock = false // æ ‡è®°æ˜¯å¦éœ€è¦é”å®šè¾“å…¥æ¡†
    let isHandling = false // æ ‡è®°æ˜¯å¦æ­£åœ¨å¤„ç†
    let lastValue = null
    // inputäº‹ä»¶å¤„ç†å‡½æ•°
    const handler = () => {
      if (lock) return // å¦‚æœå½“å‰ä¸ºé”å®šçŠ¶æ€ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
      if (isHandling) return // å¦‚æœå·²ç»åœ¨å¤„ç†ä¸­ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
      if (el.value === lastValue) return // è¾“å…¥å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†
      isHandling = true // è®¾ç½®æ ‡è®°ä¸ºå¤„ç†ä¸­
      const modifiers = Object.keys(binding.modifiers)
      const newModifier = modifiers[0] || 'num'
      map[newModifier](el, binding.value || 2)
      lastValue = el.value // è®°å½•å½“å‰è¾“å…¥æ¡†çš„å€¼
      Promise.resolve().then(() => {
        // å¼‚æ­¥å¤„ç†ï¼Œåœºæ™¯ï¼šç«ç‹æµè§ˆå™¨ä¸­ï¼Œéœ€è¦åœ¨æœ€åæ´¾å‘inputäº‹ä»¶
        el.dispatchEvent(new Event('input'))
      })
      isHandling = false // å¤„ç†å®Œæ¯•åè®¾ç½®æ ‡è®°ä¸ºéå¤„ç†çŠ¶æ€
    }
    el.addEventListener('input', handler)
    // compositionstartå’Œcompositionendäº‹ä»¶è§£å†³çš„bugåœºæ™¯ï¼šé™åˆ¶åªèƒ½è¾“å…¥æ•°å­—çš„è¾“å…¥æ¡†ï¼Œå…ˆè¾“å…¥æ•°å­—ï¼Œå†åˆ‡æ¢ä¸ºä¸­æ–‡è¾“å…¥æ³•ï¼Œè¾“å…¥å­—æ¯æ—¶ï¼Œä¼šå°†åŸæ¥çš„æ•°å­—åˆ æ‰
    el.addEventListener('compositionstart', () => {
      lock = true
    })
    el.addEventListener('compositionend', () => {
      lock = false
      el.dispatchEvent(new Event('input'))
    })
    // å½“æŒ‡ä»¤ä¸å…ƒç´ è§£ç»‘æ—¶ï¼Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    vnode.context.$once('hook:destroyed', () => {
      el.removeEventListener('input', handler)
    })
  }
}








 bind(el) {
      Vue.nextTick(() => {